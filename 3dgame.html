<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
		<title>3D Game Design</title>
		<script src="scripts/cannon.js"></script>
		<script src="scripts/babylon.js"></script>
		<script src="scripts/babylon.objFileLoader.min.js"></script> 
		<script> 
			function start() {
				var canvas = document.getElementById('renderCanvas');
				var engine = new BABYLON.Engine(canvas, true);

				var keys = new BABYLON.Engine (canvas, true);
				window.addEventListener('keydown', function (e) {
				keys[e.key] = true;
				});

				window.addEventListener('keyup', function(e) {
				keys[e.key] = false;
				}); 
			
				
				var scene = new BABYLON.Scene(engine);
				var gravityVector = new BABYLON.Vector3(0, -9.81, 0);
				scene.enablePhysics(gravityVector, new BABYLON.CannonJSPlugin()); 

				scene.clearColor = new BABYLON.Color3(0.5, 0.8, 0.5); 

				 //===TRACK CODE===//
				var _xFn = function(t) {var fns = [function(t) {return (Math.pow((1-t),3)*0.6525)+(3*t*Math.pow((1-t),2)*0.4525)+(3*Math.pow(t,2)*(1-t)*0.72)+(Math.pow(t,3)*0.8525)},function(t) {return (Math.pow((1-t),3)*0.8525)+(3*t*Math.pow((1-t),2)*0.985)+(3*Math.pow(t,2)*(1-t)*0.1775)+(Math.pow(t,3)*0.1775)},function(t) {return (Math.pow((1-t),3)*0.1775)+(3*t*Math.pow((1-t),2)*0.1775)+(3*Math.pow(t,2)*(1-t)*0.3375)+(Math.pow(t,3)*0.2625)},function(t) {return (Math.pow((1-t),3)*0.2625)+(3*t*Math.pow((1-t),2)*0.1875)+(3*Math.pow(t,2)*(1-t)*0.465)+(Math.pow(t,3)*0.465)},function(t) {return (Math.pow((1-t),3)*0.465)+(3*t*Math.pow((1-t),2)*0.465)+(3*Math.pow(t,2)*(1-t)*0.9225)+(Math.pow(t,3)*0.815)},function(t) {return (Math.pow((1-t),3)*0.815)+(3*t*Math.pow((1-t),2)*0.7075)+(3*Math.pow(t,2)*(1-t)*0.8425)+(Math.pow(t,3)*0.8425)},function(t) {return (Math.pow((1-t),3)*0.8425)+(3*t*Math.pow((1-t),2)*0.8425)+(3*Math.pow(t,2)*(1-t)*0.885)+(Math.pow(t,3)*0.885)},function(t) {return (Math.pow((1-t),3)*0.885)+(3*t*Math.pow((1-t),2)*0.885)+(3*Math.pow(t,2)*(1-t)*0.5125)+(Math.pow(t,3)*0.5125)},function(t) {return (Math.pow((1-t),3)*0.5125)+(3*t*Math.pow((1-t),2)*0.5125)+(3*Math.pow(t,2)*(1-t)*0.6375)+(Math.pow(t,3)*0.205)},function(t) {return (Math.pow((1-t),3)*0.205)+(3*t*Math.pow((1-t),2)*-0.2275)+(3*Math.pow(t,2)*(1-t)*0.765)+(Math.pow(t,3)*0.765)}];var i = Math.max(0,Math.min(9, Math.floor(t * 10)));return fns[i]((t - (i/10)) * 10);};
				var _yFn = function(t) {var fns = [function(t) {return (Math.pow((1-t),3)*0.3553333282470703)+(3*t*Math.pow((1-t),2)*0.5328333282470703)+(3*Math.pow(t,2)*(1-t)*0.6103333282470703)+(Math.pow(t,3)*0.8578333282470703)},function(t) {return (Math.pow((1-t),3)*0.8578333282470703)+(3*t*Math.pow((1-t),2)*1.1053333282470703)+(3*Math.pow(t,2)*(1-t)*0.6253333282470703)+(Math.pow(t,3)*0.6253333282470703)},function(t) {return (Math.pow((1-t),3)*0.6253333282470703)+(3*t*Math.pow((1-t),2)*0.6253333282470703)+(3*Math.pow(t,2)*(1-t)*0.3453333282470703)+(Math.pow(t,3)*0.4328333282470703)},function(t) {return (Math.pow((1-t),3)*0.4328333282470703)+(3*t*Math.pow((1-t),2)*0.5203333282470703)+(3*Math.pow(t,2)*(1-t)*0.32033332824707034)+(Math.pow(t,3)*0.32033332824707034)},function(t) {return (Math.pow((1-t),3)*0.32033332824707034)+(3*t*Math.pow((1-t),2)*0.32033332824707034)+(3*Math.pow(t,2)*(1-t)*0.9678333282470704)+(Math.pow(t,3)*0.4128333282470703)},function(t) {return (Math.pow((1-t),3)*0.4128333282470703)+(3*t*Math.pow((1-t),2)*-0.14216667175292969)+(3*Math.pow(t,2)*(1-t)*0.4328333282470703)+(Math.pow(t,3)*0.4328333282470703)},function(t) {return (Math.pow((1-t),3)*0.4328333282470703)+(3*t*Math.pow((1-t),2)*0.4328333282470703)+(3*Math.pow(t,2)*(1-t)*0.6078333282470703)+(Math.pow(t,3)*0.6078333282470703)},function(t) {return (Math.pow((1-t),3)*0.6078333282470703)+(3*t*Math.pow((1-t),2)*0.6078333282470703)+(3*Math.pow(t,2)*(1-t)*0.4903333282470703)+(Math.pow(t,3)*0.4903333282470703)},function(t) {return (Math.pow((1-t),3)*0.4903333282470703)+(3*t*Math.pow((1-t),2)*0.4903333282470703)+(3*Math.pow(t,2)*(1-t)*0.2153333282470703)+(Math.pow(t,3)*0.2278333282470703)},function(t) {return (Math.pow((1-t),3)*0.2278333282470703)+(3*t*Math.pow((1-t),2)*0.24033332824707032)+(3*Math.pow(t,2)*(1-t)*0.09283332824707032)+(Math.pow(t,3)*0.09283332824707032)}];var i = Math.max(0,Math.min(9, Math.floor(t * 10)));return fns[i]((t - (i/10)) * 10);};
/* START CURVE DATA 
{"start":[261,142.13333129882812],"init":[181,213.13333129882812],"segments":[{"a":[288,244.13333129882812],"b":[341,343.1333312988281]},{"a":[71,250.13333129882812],"b":[71,250.13333129882812]},{"a":[135,138.13333129882812],"b":[105,173.13333129882812]},{"a":[186,128.13333129882812],"b":[186,128.13333129882812]},{"a":[369,387.1333312988281],"b":[326,165.13333129882812]},{"a":[337,173.13333129882812],"b":[337,173.13333129882812]},{"a":[354,243.13333129882812],"b":[354,243.13333129882812]},{"a":[205,196.13333129882812],"b":[205,196.13333129882812]},{"a":[255,86.13333129882812],"b":[82,91.13333129882812]},{"a":[306,37.133331298828125],"b":[306,37.133331298828125]}]}
   END CURVE DATA */
				//===END TRACK CODE===//

				var xFn = function(t) { return 650 * _xFn(t); }
				var zFn = function(t) { return 650 * _yFn(t); }

				var playerSphere = BABYLON.MeshBuilder.CreateSphere("playerSphere", {
					segments: 12,
					diameter: 4
				}, scene);

				playerSphere.material = new BABYLON.StandardMaterial("playerSphereMaterial", scene);
				playerSphere.material.diffuseTexture = new BABYLON.Texture('resources/BeachBallColor.jpg', scene);
				 playerSphere.position = new BABYLON.Vector3(xFn(0), 9, zFn(0));

				playerSphere.position = new BABYLON.Vector3(0, 5, 0);

				playerSphere.physicsImpostor = new BABYLON.PhysicsImpostor(playerSphere, BABYLON.PhysicsImpostor.SphereImpostor, {
					mass: 1,
					restitution: 0.9
					}, scene); 


				drawParametric(xFn, zFn, 0, 1, 10000, scene);


				var camera = new BABYLON.ArcRotateCamera("Camera", 0, (3 * Math.PI) / 8, 20, playerSphere, scene); 
				camera.attachControl(canvas, true);

				var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);
				
				scene.registerAfterRender(function() {
					var vel = playerSphere.physicsImpostor.getLinearVelocity();
					playerSphere.physicsImpostor.setLinearVelocity(vel.scale(.98));

					var forward = camera.getFrontPosition(1).subtract(camera.position);
					forward.y = 0;
					forward = forward.normalize().scale(1);

					var backward = BABYLON.Vector3.TransformCoordinates(forward, BABYLON.Matrix.RotationY(Math.PI));

					var left = BABYLON.Vector3.TransformCoordinates(forward, BABYLON.Matrix.RotationY((3 * Math.PI) / 2));

					var right = BABYLON.Vector3.TransformCoordinates(forward, BABYLON.Matrix.RotationY(Math.PI / 2));

					if (keys.w) {
					playerSphere.applyImpulse(forward, playerSphere.getAbsolutePosition());
					}
					if (keys.s) {
					playerSphere.applyImpulse(backward, playerSphere.getAbsolutePosition());
					}
					if (keys.a) {
					playerSphere.applyImpulse(left, playerSphere.getAbsolutePosition());
					}
					if (keys.d) {
					playerSphere.applyImpulse(right, playerSphere.getAbsolutePosition());
					
					}
					var currentT = tLookup(xFn, zFn, 500, playerSphere.position.x, playerSphere.position.z); 
						
						if (currentT > 0.99) {
						win();
						} 
						if (playerSphere.position.y < -10) {
						lost();
						} 
						 }); 

				function drawPoint(x, z, zrot, scene) {
					var point = BABYLON.MeshBuilder.CreateBox('point', {
						width: 10,
						height: 0.5,
						depth: 12
						}, scene);
					point.material = new BABYLON.StandardMaterial("pointMaterial", scene);
					point.material.diffuseColor = new BABYLON.Color3(1, 0, 1);
					point.position = new BABYLON.Vector3(x, 0.1, z);
					point.rotation.y = zrot;
					point.physicsImpostor = new BABYLON.PhysicsImpostor(point, BABYLON.PhysicsImpostor.BoxImpostor, {
					mass: 0,
					restitution: 0.9
					}, scene);
				}

		        arametric(xFn, zFn, 0, 1, 350, scene);

			
} 
			  function drawParametric(xFn, zFn, start, end, res, scene) {
			    for (var t = start; t <= end; t += ((end - start) / res)) {
			      drawPoint(xFn(t), zFn(t), 0, scene);
			    }
			  }
 				drawParametric(xFn, zFn, 0, 1, 350, scene); 

 				function tLookup(xFn, zFn, res, x, z) {
						var minT = 0;
						var minDist = Infinity;
						for (var t = 0; t <= 1; t += (1 / res)) {
						var dist = Math.pow(x - xFn(t), 2) + Math.pow(z - zFn(t), 2);
						if (dist < minDist) {
						minDist = dist;
						minT = t;
						}
						}
						return minT;
						} 
				engine.runRenderLoop(scene.render.bind(scene));
				window.addEventListener('resize', engine.resize.bind(engine)); 
			}
							function win(){
				window.location.reload();
				alert("You WIN!");
				} 


				function lost(){
					window.location.reload();
					alert("you lose!");
			}

		</script> 

		<style>
         html, body { 
	       overflow; hidden;
	       width: 100%;
	       height:100%;
	       margin: 0%;
	       padding: 0%;
       }
           #renderCanvas {
           	width: 100%;
           	height: 100%;
           	touch-action: none;
           }
        </style>

	    </head> 
	    <body onload="start()">
			<canvas id="renderCanvas"></canvas>
	    </body> 
        </html>